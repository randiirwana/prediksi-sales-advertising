{% extends "base.html" %}

{% block title %}Prediksi Sales Advertising - Home{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="fas fa-bullhorn me-3"></i>
                    Prediksi Sales Advertising
                </h1>
                <p class="lead">
                    Prediksi penjualan berdasarkan anggaran iklan di TV, Radio, dan Newspaper menggunakan Machine Learning
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Main Form Section -->
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            Form Prediksi Sales
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        {% if error %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ error }}
                        </div>
                        {% endif %}

                        <form method="POST" action="/predict" id="predictionForm">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tv_budget" class="form-label">
                                        <i class="fas fa-tv text-primary me-2"></i>
                                        Anggaran Iklan TV
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="tv_budget" 
                                               name="tv_budget" 
                                               step="0.1" 
                                               min="0"
                                               value="{{ result.tv_budget if result else '' }}"
                                               placeholder="0.0"
                                               required>
                                    </div>
                                    <small class="text-muted">Biaya iklan TV dalam ribuan dolar</small>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="radio_budget" class="form-label">
                                        <i class="fas fa-broadcast-tower text-success me-2"></i>
                                        Anggaran Iklan Radio
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="radio_budget" 
                                               name="radio_budget" 
                                               step="0.1" 
                                               min="0"
                                               value="{{ result.radio_budget if result else '' }}"
                                               placeholder="0.0"
                                               required>
                                    </div>
                                    <small class="text-muted">Biaya iklan Radio dalam ribuan dolar</small>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="newspaper_budget" class="form-label">
                                        <i class="fas fa-newspaper text-warning me-2"></i>
                                        Anggaran Iklan Newspaper
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="newspaper_budget" 
                                               name="newspaper_budget" 
                                               step="0.1" 
                                               min="0"
                                               value="{{ result.newspaper_budget if result else '' }}"
                                               placeholder="0.0"
                                               required>
                                    </div>
                                    <small class="text-muted">Biaya iklan Newspaper dalam ribuan dolar</small>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-magic me-2"></i>
                                    Prediksi Sales
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        {% if result %}
        <div class="row justify-content-center mt-5">
            <div class="col-lg-12">
                <div class="card result-card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Hasil Prediksi
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-center mb-4">
                                    <h2 class="display-4 fw-bold">{{ result.predicted_sales }}</h2>
                                    <p class="lead">Unit Sales yang Diprediksi</p>
                                </div>
                                
                                <!-- Grafik Kontribusi Media -->
                                <div class="chart-container">
                                    <canvas id="contributionChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Detail Kontribusi:</h5>
                                <div class="contribution-item">
                                    <strong>Base Sales:</strong> {{ result.base_sales }} unit
                                </div>
                                <div class="contribution-item">
                                    <strong>TV Contribution:</strong> +{{ result.tv_contribution }} unit
                                    <small>({{ result.tv_budget }} × {{ "%.4f"|format(0.0549) }})</small>
                                </div>
                                <div class="contribution-item">
                                    <strong>Radio Contribution:</strong> +{{ result.radio_contribution }} unit
                                    <small>({{ result.radio_budget }} × {{ "%.4f"|format(0.1096) }})</small>
                                </div>
                                <div class="contribution-item">
                                    <strong>Newspaper Contribution:</strong> {{ result.newspaper_contribution }} unit
                                    <small>({{ result.newspaper_budget }} × {{ "%.4f"|format(-0.0062) }})</small>
                                </div>
                                <div class="contribution-item">
                                    <strong>Total Media Contribution:</strong> +{{ result.total_contribution }} unit
                                </div>
                                
                                <!-- Grafik Breakdown Sales -->
                                <div class="chart-container mt-4">
                                    <canvas id="salesBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Grafik Perbandingan Budget vs Kontribusi -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="chart-container">
                                    <canvas id="budgetVsContributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Information Cards -->
        <div class="row mt-5">
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-info-circle text-primary fa-3x mb-3"></i>
                        <h5>Model Accuracy</h5>
                        <p class="text-muted">Model ini memiliki akurasi R² sebesar 89.7% dalam memprediksi sales.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-lightbulb text-warning fa-3x mb-3"></i>
                        <h5>Insight</h5>
                        <p class="text-muted">Radio memiliki dampak paling besar per dollar yang diinvestasikan.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line text-success fa-3x mb-3"></i>
                        <h5>Data Training</h5>
                        <p class="text-muted">Model dilatih menggunakan 200 data points untuk akurasi optimal.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    document.getElementById('predictionForm').addEventListener('submit', function(e) {
        const tvBudget = parseFloat(document.getElementById('tv_budget').value);
        const radioBudget = parseFloat(document.getElementById('radio_budget').value);
        const newspaperBudget = parseFloat(document.getElementById('newspaper_budget').value);
        
        if (tvBudget < 0 || radioBudget < 0 || newspaperBudget < 0) {
            e.preventDefault();
            alert('Anggaran tidak boleh negatif!');
            return false;
        }
        
        if (isNaN(tvBudget) || isNaN(radioBudget) || isNaN(newspaperBudget)) {
            e.preventDefault();
            alert('Masukkan angka yang valid untuk semua field!');
            return false;
        }
    });

    // Auto-format input
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', function() {
            if (this.value < 0) {
                this.value = 0;
            }
        });
    });

    // Chart.js untuk visualisasi data
    {% if result %}
    // Data untuk grafik
    const chartData = {
        tvBudget: {{ result.tv_budget }},
        radioBudget: {{ result.radio_budget }},
        newspaperBudget: {{ result.newspaper_budget }},
        tvContribution: {{ result.tv_contribution }},
        radioContribution: {{ result.radio_contribution }},
        newspaperContribution: {{ result.newspaper_contribution }},
        baseSales: {{ result.base_sales }},
        totalContribution: {{ result.total_contribution }},
        predictedSales: {{ result.predicted_sales }}
    };

    // Grafik Kontribusi Media (Bar Chart)
    const contributionCtx = document.getElementById('contributionChart').getContext('2d');
    new Chart(contributionCtx, {
        type: 'bar',
        data: {
            labels: ['TV', 'Radio', 'Newspaper'],
            datasets: [{
                label: 'Kontribusi terhadap Sales (unit)',
                data: [chartData.tvContribution, chartData.radioContribution, chartData.newspaperContribution],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Kontribusi Media terhadap Sales'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Kontribusi (unit)'
                    }
                }
            }
        }
    });

    // Grafik Breakdown Sales (Doughnut Chart)
    const salesBreakdownCtx = document.getElementById('salesBreakdownChart').getContext('2d');
    new Chart(salesBreakdownCtx, {
        type: 'doughnut',
        data: {
            labels: ['Base Sales', 'TV Contribution', 'Radio Contribution', 'Newspaper Contribution'],
            datasets: [{
                data: [
                    chartData.baseSales,
                    chartData.tvContribution,
                    chartData.radioContribution,
                    chartData.newspaperContribution
                ],
                backgroundColor: [
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ],
                borderColor: [
                    'rgba(153, 102, 255, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Breakdown Total Sales'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Grafik Perbandingan Budget vs Kontribusi (Line Chart)
    const budgetVsContributionCtx = document.getElementById('budgetVsContributionChart').getContext('2d');
    new Chart(budgetVsContributionCtx, {
        type: 'line',
        data: {
            labels: ['TV', 'Radio', 'Newspaper'],
            datasets: [{
                label: 'Budget ($1000)',
                data: [chartData.tvBudget, chartData.radioBudget, chartData.newspaperBudget],
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y'
            }, {
                label: 'Kontribusi (unit)',
                data: [chartData.tvContribution, chartData.radioContribution, chartData.newspaperContribution],
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Perbandingan Budget vs Kontribusi'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Media'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Budget ($1000)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Kontribusi (unit)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
